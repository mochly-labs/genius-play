<!DOCTYPE html>
<html lang="pt-BR" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Genius Play! - Criador</title>
    <script src="/scripts/tailwind.js"></script>
    <script src="/scripts/sortable.js"></script>
    <script src="/scripts/genius-core/toasty.js"></script>
    <link href="icons/css/fontawesome.css" rel="stylesheet" />
    <link href="icons/css/brands.css" rel="stylesheet" />
    <link href="icons/css/solid.css" rel="stylesheet" />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap");

      body {
        font-family: "Poppins", sans-serif;
      }
      
      .gradient-text {
        background: linear-gradient(to right, #f7b733, #fc4a1a);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .glass-card {
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-radius: 0.75rem;
        border: none;
      }

      .input-field {
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 0.5rem;
        color: #e5e7eb;
      }

      .input-field::placeholder {
        color: #9ca3af;
      }

      .input-field:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(252, 74, 26, 0.5);
      }

      .btn {
        border: none;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
      }
      .btn-primary {
        background: #fc4a1a;
        background: -webkit-linear-gradient(to right, #f7b733, #fc4a1a);
        background: linear-gradient(to right, #f7b733, #fc4a1a);
      }
      .btn-primary:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      }
      
      .tab-button {
        transition: all 0.2s ease;
      }
      .tab-button.active {
        background-color: rgba(252, 74, 26, 0.7);
        color: white;
      }
      
      * {
          border-style: none !important;
      }
    </style>
  </head>
  <body class="text-gray-200 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
      <header class="mb-10 text-center">
        <h1 class="text-5xl font-bold gradient-text mb-2">Genius Play!</h1> 
      </header>

      <div class="glass-card p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
          <div>
            <label
              for="quizTitle"
              class="block text-sm font-medium text-gray-300 mb-2"
              >Nome do Questionário</label
            >
            <input
              type="text"
              id="quizTitle"
              placeholder="Digite o nome do questionário"
              class="w-full input-field px-4 py-2 text-lg"
            />
          </div>
          <div class="flex items-center justify-center flex-wrap gap-3">
            <button
              id="importBtn"
              class="btn btn-primary text-white px-4 py-2 flex items-center gap-2"
            >
              <i class="fas fa-file-import"></i> Importar (.qn)
            </button>
            <button
              id="importBtn2"
              class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 flex items-center gap-2"
            >
              <i class="fas fa-file-import"></i> Importar (.json)
            </button>
            <button
              id="exportBtn"
              class="btn bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 flex items-center gap-2"
            >
              <i class="fas fa-file-export"></i> Exportar (JSON)
            </button>
             <input type="file" id="fileInput" class="hidden" accept=".qn" />
             <input type="file" id="fileInput2" class="hidden" accept=".json"/>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <div class="glass-card p-6 flex flex-col gap-6">
            <h2 class="text-lg font-semibold text-gray-200">Mídia do Quiz</h2>
            <div class="flex items-center gap-3">
              <label for="bgUpload" class="cursor-pointer btn btn-primary text-white px-4 py-2 flex items-center gap-2">
                <i class="fas fa-image"></i> Background
              </label>
              <input type="file" id="bgUpload" class="hidden" accept="image/*" />
              <button id="clearBgBtn" class="btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-2">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div id="bgPreviewContainer" class="mt-2 hidden">
              <img id="bgPreview" class="rounded-lg max-h-40"/>
            </div>
            <div class="flex items-center gap-3">
              <label for="musicUpload" class="cursor-pointer btn btn-primary text-white px-4 py-2 flex items-center gap-2">
                <i class="fas fa-music"></i> Música
              </label>
              <input type="file" id="musicUpload" class="hidden" accept="audio/*" />
              <button id="clearMusicBtn" class="btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-2">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div id="musicPreviewContainer" class="mt-2 hidden">
              <audio id="musicPreview" controls class="w-full"></audio>
            </div>
        </div>
        <div id="previewSection" class="glass-card p-6 hidden">
             <h2 class="text-lg font-semibold text-gray-200 mb-4">
              Pré-visualização do JSON
            </h2>
            <pre
              id="filePreview"
              class="bg-black/50 p-4 rounded-md overflow-x-auto text-gray-300 text-sm max-h-96 overflow-y-auto"
            ></pre>
        </div>
      </div>

      <div id="questionsContainer" class="space-y-6">
      </div>

      <button
        id="addQuestionBtn"
        class="mt-8 w-full btn btn-primary text-white px-4 py-3 flex items-center justify-center gap-2 text-lg font-semibold"
      >
        <i class="fas fa-plus"></i> Adicionar Pergunta
      </button>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const quizTitle = document.getElementById("quizTitle");
        const questionsContainer =
          document.getElementById("questionsContainer");
        const addQuestionBtn = document.getElementById("addQuestionBtn");
        const importBtn = document.getElementById("importBtn");
        const importBtn2 = document.getElementById("importBtn2");
        const exportBtn = document.getElementById("exportBtn");
        const fileInput = document.getElementById("fileInput");
        const fileInput2 = document.getElementById("fileInput2");
        const previewSection = document.getElementById("previewSection");
        const filePreview = document.getElementById("filePreview");

        // Media upload elements
        const bgUpload = document.getElementById("bgUpload");
        const musicUpload = document.getElementById("musicUpload");
        const bgPreview = document.getElementById("bgPreview");
        const bgPreviewContainer =
          document.getElementById("bgPreviewContainer");
        const musicPreview = document.getElementById("musicPreview");
        const musicPreviewContainer = document.getElementById(
          "musicPreviewContainer"
        );
        const clearBgBtn = document.getElementById("clearBgBtn");
        const clearMusicBtn = document.getElementById("clearMusicBtn");

        let backgroundBase64 = null;
        let musicBase64 = null;

        // Initialize SortableJS for drag and drop
        new Sortable(questionsContainer, {
          handle: ".drag-handle",
          animation: 150,
          ghostClass: "bg-orange-900/50",
        });

        // Add new question
        addQuestionBtn.addEventListener("click", function () {
          addNewQuestion();
        });

        // Import .qn file
        importBtn.addEventListener("click", function () {
          fileInput.click();
        });
        importBtn2.addEventListener("click", function () {
          fileInput2.click();
        });

        fileInput.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              parseQNFile(e.target.result);
            };
            reader.readAsText(file);
          }
        });
        fileInput2.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              parseJSONFile(e.target.result);
            };
            reader.readAsText(file);
          }
        });

        // Export JSON file
        exportBtn.addEventListener("click", function () {
          exportJSONFile();
        });

        // Background upload
        bgUpload.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              backgroundBase64 = e.target.result;
              bgPreview.src = backgroundBase64;
              bgPreviewContainer.classList.remove("hidden");
              updatePreview();
            };
            reader.readAsDataURL(file);
          }
        });

        // Music upload
        musicUpload.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              musicBase64 = e.target.result;
              musicPreview.src = musicBase64;
              musicPreviewContainer.classList.remove("hidden");
              updatePreview();
            };
            reader.readAsDataURL(file);
          }
        });

        // Clear background
        clearBgBtn.addEventListener("click", function () {
          backgroundBase64 = null;
          bgPreview.src = "";
          bgPreviewContainer.classList.add("hidden");
          bgUpload.value = "";
          updatePreview();
        });

        // Clear music
        clearMusicBtn.addEventListener("click", function () {
          musicBase64 = null;
          musicPreview.src = "";
          musicPreviewContainer.classList.add("hidden");
          musicUpload.value = "";
          updatePreview();
        });

        function addNewQuestion(questionData) {
          const questionId = Date.now();
          const questionItem = document.createElement("div");
          questionItem.className =
            "question-item glass-card p-5";
          questionItem.dataset.id = questionId;

          const defaultOptions = questionData?.alternatives
            ? questionData.alternatives.map((alt, i) => ({
                letter: String.fromCharCode(97 + i),
                text: alt,
                correct: alt === questionData.correct,
                image: questionData.optionImages
                  ? questionData.optionImages[i]
                  : null,
              }))
            : [
                { letter: "a", text: "", correct: false, image: null },
                { letter: "b", text: "", correct: false, image: null },
              ];

          questionItem.innerHTML = `
            <div class="flex items-start gap-4">
                <div class="drag-handle pt-3 text-gray-400 hover:text-white cursor-move">
                    <i class="fas fa-grip-vertical text-xl"></i>
                </div>
                <div class="flex-1">
                    <div class="mb-4">
                        <div class="flex gap-2 mb-2">
                            <button class="tab-button text-sm px-4 py-2 rounded-md active" data-tab="text">Texto</button>
                            <button class="tab-button text-sm px-4 py-2 rounded-md" data-tab="image">Imagem</button>
                        </div>
                        <div class="tab-content text-tab">
                            <input type="text" class="question-input w-full input-field px-3 py-2" 
                                    placeholder="Digite a pergunta" value="${
                                      questionData?.question || ""
                                    }">
                        </div>
                        <div class="tab-content image-tab hidden">
                            <div class="flex items-center gap-2">
                                <label for="question-image-${questionId}" class="cursor-pointer btn btn-primary text-white px-3 py-1 flex items-center gap-1 text-sm">
                                    <i class="fas fa-image"></i> Upload
                                    <input type="file" id="question-image-${questionId}" class="hidden question-image-input" accept="image/*">
                                </label>
                                <button class="clear-question-image-btn btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 text-sm">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                            <div class="question-image-preview-container mt-2 ${
                              questionData?.questionImage
                                ? ""
                                : "hidden"
                            }">
                                <img class="question-image-preview rounded-md max-h-36" ${
                                  questionData?.questionImage
                                    ? `src="${questionData.questionImage}"`
                                    : ""
                                }>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Pontos</label>
                        <input type="number" class="worth-input w-full input-field px-3 py-2" 
                                placeholder="Pontos" min="1" value="${
                                  questionData?.worth || 10
                                }">
                    </div>
                    <div id="options-${questionId}" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        ${defaultOptions
                          .map(
                            (opt) => `
                            <div class="option-item flex flex-col gap-2 ${
                              opt.correct ? "option-correct" : ""
                            }" data-letter="${opt.letter}">
                                <div class="flex items-center">
                                    <button class="correct-btn mr-3 w-7 h-7 flex items-center justify-center rounded-full ${
                                      opt.correct
                                        ? "bg-green-500"
                                        : "bg-gray-700"
                                    }">
                                        ${
                                          opt.correct
                                            ? '<i class="fas fa-check text-white text-sm"></i>'
                                            : ""
                                        }
                                    </button>
                                    <input type="text" class="option-input w-full input-field px-3 py-2" 
                                            placeholder="Opção ${opt.letter.toUpperCase()}" value="${
                              opt.text
                            }">
                                    <button class="delete-option-btn ml-2 text-gray-400 hover:text-red-400">
                                        <i class="fas fa-times text-lg"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-2 pl-10">
                                    <label for="option-image-${questionId}-${
                              opt.letter
                            }" class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded-md flex items-center gap-1 text-xs">
                                        <i class="fas fa-image"></i> Imagem
                                        <input type="file" id="option-image-${questionId}-${
                              opt.letter
                            }" class="hidden option-image-input" accept="image/*">
                                    </label>
                                    <button class="clear-option-image-btn bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded-md text-xs ${
                                      opt.image ? "" : "hidden"
                                    }">
                                        <i class="fas fa-times"></i> Limpar
                                    </button>
                                </div>
                                <div class="option-image-preview-container pl-10 ${
                                  opt.image ? "" : "hidden"
                                }">
                                    <img class="option-image-preview rounded-md max-h-20" ${
                                      opt.image
                                        ? `src="${opt.image}"`
                                        : ""
                                    }>
                                </div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                    <button class="add-option-btn text-sm bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md flex items-center gap-2">
                        <i class="fas fa-plus text-xs"></i> Adicionar Alternativa
                    </button>
                </div>
                <button class="delete-btn mt-1 text-gray-400 hover:text-red-400 text-lg">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
          `;

          questionsContainer.appendChild(questionItem);

          if (questionData?.questionImage) {
            const previewContainer = questionItem.querySelector(
              ".question-image-preview-container"
            );
            const previewImg = questionItem.querySelector(
              ".question-image-preview"
            );
            previewContainer.classList.remove("hidden");
            previewImg.src = questionData.questionImage;
          }

          const tabButtons = questionItem.querySelectorAll(".tab-button");
          const tabContents = questionItem.querySelectorAll(".tab-content");

          tabButtons.forEach((button) => {
            button.addEventListener("click", function () {
              const tab = this.dataset.tab;
              tabButtons.forEach((btn) => btn.classList.remove("active"));
              this.classList.add("active");
              tabContents.forEach((content) => {
                if (content.classList.contains(`${tab}-tab`)) {
                  content.classList.remove("hidden");
                } else {
                  content.classList.add("hidden");
                }
              });
            });
          });

          const questionImageInput = questionItem.querySelector(
            ".question-image-input"
          );
          const clearQuestionImageBtn = questionItem.querySelector(
            ".clear-question-image-btn"
          );
          const questionImagePreviewContainer = questionItem.querySelector(
            ".question-image-preview-container"
          );
          const questionImagePreview = questionItem.querySelector(
            ".question-image-preview"
          );

          questionImageInput.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                questionImagePreview.src = e.target.result;
                questionImagePreviewContainer.classList.remove("hidden");
                updatePreview();
              };
              reader.readAsDataURL(file);
            }
          });

          clearQuestionImageBtn.addEventListener("click", function () {
            questionImagePreview.src = "";
            questionImagePreviewContainer.classList.add("hidden");
            questionImageInput.value = "";
            updatePreview();
          });

          const deleteBtn = questionItem.querySelector(".delete-btn");
          deleteBtn.addEventListener("click", function () {
            questionItem.remove();
            updatePreview();
          });

          const addOptionBtn = questionItem.querySelector(".add-option-btn");
          addOptionBtn.addEventListener("click", function () {
            const optionsContainer = questionItem.querySelector(
              `#options-${questionId}`
            );
            const existingOptions =
              optionsContainer.querySelectorAll(".option-item");
            const nextLetter = String.fromCharCode(97 + existingOptions.length);

            const newOption = document.createElement("div");
            newOption.className = "option-item flex flex-col gap-2";
            newOption.dataset.letter = nextLetter;
            newOption.innerHTML = `
                <div class="flex items-center">
                    <button class="correct-btn mr-3 w-7 h-7 flex items-center justify-center rounded-full bg-gray-700"></button>
                    <input type="text" class="option-input w-full input-field px-3 py-2" 
                           placeholder="Opção ${nextLetter.toUpperCase()}">
                    <button class="delete-option-btn ml-2 text-gray-400 hover:text-red-400">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2 pl-10">
                    <label for="option-image-${questionId}-${nextLetter}" class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded-md flex items-center gap-1 text-xs">
                        <i class="fas fa-image"></i> Imagem
                        <input type="file" id="option-image-${questionId}-${nextLetter}" class="hidden option-image-input" accept="image/*">
                    </label>
                    <button class="clear-option-image-btn bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded-md text-xs hidden">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </div>
                <div class="option-image-preview-container pl-10 hidden">
                    <img class="option-image-preview rounded-md max-h-20">
                </div>
            `;

            optionsContainer.appendChild(newOption);

            const correctBtn = newOption.querySelector(".correct-btn");
            correctBtn.addEventListener("click", () => markOptionAsCorrect(newOption));

            const deleteOptionBtn = newOption.querySelector(".delete-option-btn");
            deleteOptionBtn.addEventListener("click", () => {
              newOption.remove();
              updatePreview();
            });

            const optionImageInput = newOption.querySelector(".option-image-input");
            optionImageInput.addEventListener("change", (e) => handleOptionImageUpload(e, newOption));
            
            const clearOptionImageBtn = newOption.querySelector(".clear-option-image-btn");
            clearOptionImageBtn.addEventListener("click", () => clearOptionImage(newOption));

            updatePreview();
          });

          questionItem.querySelectorAll(".correct-btn").forEach(btn => {
              btn.addEventListener("click", () => markOptionAsCorrect(btn.closest(".option-item")));
          });

          questionItem.querySelectorAll(".delete-option-btn").forEach(btn => {
              btn.addEventListener("click", () => {
                  btn.closest(".option-item").remove();
                  updatePreview();
              });
          });

          questionItem.querySelectorAll(".option-image-input").forEach(input => {
              input.addEventListener("change", (e) => handleOptionImageUpload(e, input.closest(".option-item")));
          });
          
          questionItem.querySelectorAll(".clear-option-image-btn").forEach(btn => {
              btn.addEventListener("click", () => clearOptionImage(btn.closest(".option-item")));
          });

          const inputs = questionItem.querySelectorAll("input");
          inputs.forEach((input) => {
            if (!input.classList.contains("hidden")) { // changed from file-input
              input.addEventListener("input", updatePreview);
            }
          });

          updatePreview();
        }

        function handleOptionImageUpload(event, optionItem) {
            const file = event.target.files[0];
            if (file) {
                const previewContainer = optionItem.querySelector(".option-image-preview-container");
                const previewImg = optionItem.querySelector(".option-image-preview");
                const clearBtn = optionItem.querySelector(".clear-option-image-btn");
                const reader = new FileReader();
                reader.onload = function (e) {
                    previewImg.src = e.target.result;
                    previewContainer.classList.remove("hidden");
                    clearBtn.classList.remove("hidden");
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        }

        function clearOptionImage(optionItem) {
            const previewContainer = optionItem.querySelector(".option-image-preview-container");
            const previewImg = optionItem.querySelector(".option-image-preview");
            const input = optionItem.querySelector(".option-image-input");
            const clearBtn = optionItem.querySelector(".clear-option-image-btn");
            
            previewImg.src = "";
            previewContainer.classList.add("hidden");
            input.value = "";
            clearBtn.classList.add("hidden");
            updatePreview();
        }

        function markOptionAsCorrect(optionItem) {
          const questionItem = optionItem.closest(".question-item");
          questionItem.querySelectorAll(".option-item").forEach((item) => {
            item.classList.remove("option-correct");
            const btn = item.querySelector(".correct-btn");
            btn.classList.remove("bg-green-500");
            btn.classList.add("bg-gray-700");
            btn.innerHTML = "";
          });
          optionItem.classList.add("option-correct");
          const btn = optionItem.querySelector(".correct-btn");
          btn.classList.remove("bg-gray-700");
          btn.classList.add("bg-green-500");
          btn.innerHTML = '<i class="fas fa-check text-white text-sm"></i>';
          updatePreview();
        }

        function parseJSONFile(content) {
          try {
            const quizData = JSON.parse(content);
            if (!quizData.title || !Array.isArray(quizData.questions)) {
              throw new Error("Invalid format.");
            }
            quizTitle.value = quizData.title;
            if (quizData.background) {
              backgroundBase64 = quizData.background;
              bgPreview.src = backgroundBase64;
              bgPreviewContainer.classList.remove("hidden");
            }
            if (quizData.music) {
              musicBase64 = quizData.music;
              musicPreview.src = musicBase64;
              musicPreviewContainer.classList.remove("hidden");
            }
            questionsContainer.innerHTML = "";
            quizData.questions.forEach((question) => {
              addNewQuestion(question);
            });
            updatePreview();
          } catch (error) {
            alert("Erro ao importar o arquivo JSON. Verifique o formato.");
            console.error(error);
          }
        }

        function parseQNFile(content) {
          try {
            const lines = content.split("\n").filter((line) => line.trim() !== "");
            if (lines.length === 0) return;
            const titleLine = lines[0];
            if (titleLine.startsWith("#")) {
              quizTitle.value = titleLine.substring(1).trim();
            }
            questionsContainer.innerHTML = "";
            for (let i = 1; i < lines.length; i++) {
              const line = lines[i];
              if (!line.includes("%")) continue;
              const parts = line.split("%").map((part) => part.trim());
              if (parts.length < 2) continue;
              const questionText = parts[0];
              const alternatives = [];
              let correctOption = null;
              for (let j = 1; j < parts.length; j++) {
                const optionText = parts[j];
                if (optionText.startsWith("*")) {
                  correctOption = optionText.substring(1).trim();
                  alternatives.push(correctOption);
                } else {
                  alternatives.push(optionText.trim());
                }
              }
              addNewQuestion({
                question: questionText,
                alternatives: alternatives,
                correct: correctOption,
                worth: 10,
              });
            }
            updatePreview();
          } catch (error) {
            alert("Erro ao importar o arquivo .qn. Verifique o formato.");
            console.error(error);
          }
        }

        function exportJSONFile() {
          if (!quizTitle.value.trim()) {
            alert("Por favor, insira um nome para o questionário.");
            return;
          }
          const questions = Array.from(
            questionsContainer.querySelectorAll(".question-item")
          );
          if (questions.length === 0) {
            alert("Adicione pelo menos uma pergunta antes de exportar.");
            return;
          }

          const quizData = buildQuizData(false); // false = get full base64 data

          if (quizData.questions.length === 0) {
            alert("Nenhuma pergunta válida encontrada.");
            return;
          }

          const blob = new Blob([JSON.stringify(quizData, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${quizTitle.value.trim().replace(/\s+/g, "_")}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        function updatePreview() {
            const hasContent = quizTitle.value.trim() || questionsContainer.children.length > 0 || backgroundBase64 || musicBase64;
            
            if (!hasContent) {
                previewSection.classList.add("hidden");
                return;
            }
            
            const quizDataForPreview = buildQuizData(true); // true = use placeholders for media
            filePreview.textContent = JSON.stringify(quizDataForPreview, null, 2);
            previewSection.classList.remove("hidden");
        }
        
        function buildQuizData(usePlaceholders) {
            const quizData = {
                title: quizTitle.value.trim(),
                background: usePlaceholders ? (backgroundBase64 ? "[base64 image data]" : null) : backgroundBase64,
                music: usePlaceholders ? (musicBase64 ? "[base64 audio data]" : null) : musicBase64,
                questions: [],
            };

            const questions = Array.from(questionsContainer.querySelectorAll(".question-item"));
            questions.forEach((question) => {
                const questionInput = question.querySelector(".question-input");
                const worthInput = question.querySelector(".worth-input");
                const questionText = questionInput ? questionInput.value.trim() : "";
                
                const questionImageTab = question.querySelector(".image-tab");
                const questionImagePreview = question.querySelector(".question-image-preview");
                const questionImageSrc = questionImageTab && !questionImageTab.classList.contains("hidden") && questionImagePreview.src.startsWith('data:image') ? questionImagePreview.src : null;
                
                if (!questionText && !questionImageSrc) return;
                
                const alternatives = [];
                const optionImages = [];
                let correct = null;
                
                const options = question.querySelectorAll(".option-item");
                options.forEach((option) => {
                    const input = option.querySelector(".option-input");
                    const optionText = input ? input.value.trim() : "";
                    
                    const optionImagePreview = option.querySelector(".option-image-preview");
                    const optionImageSrc = optionImagePreview && optionImagePreview.src.startsWith('data:image') ? optionImagePreview.src : null;
                    
                    if (optionText || optionImageSrc) {
                        alternatives.push(optionText || "");
                        optionImages.push(usePlaceholders ? (optionImageSrc ? "[base64 image data]" : null) : optionImageSrc);
                        
                        if (option.classList.contains("option-correct")) {
                            correct = optionText || "";
                        }
                    }
                });

                if (alternatives.length >= 2 && correct !== null) {
                    quizData.questions.push({
                        question: questionText,
                        questionImage: usePlaceholders ? (questionImageSrc ? "[base64 image data]" : null) : questionImageSrc,
                        alternatives: alternatives,
                        optionImages: optionImages,
                        correct: correct,
                        worth: parseInt(worthInput.value) || 10,
                    });
                }
            });
            return quizData;
        }

        // Add initial question
        addNewQuestion();
      });
    </script>
  </body>
</html>